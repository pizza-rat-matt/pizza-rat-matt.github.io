const data = {
  name: "Elevate others and myself to experience life",
  importance: 2,
  stress: 0.1,
  levelOfEffort: 0,
  children: [
    {
      name: "Home maintenance",
      importance: 1,
      stress: 0,
      levelOfEffort: 0,
    },
    {
      name: "Get divorced",
      importance: 1,
      stress: 0,
      levelOfEffort: 0,
    },
    {
      name: "Little monkey and baby racoon",
      importance: 1,
      stress: 0,
      levelOfEffort: 0,
      children: [
        {
          name: "Boston planning",
          importance: 0.8,
          stress: 0.2,
          levelOfEffort: 0,
          children: [
            {
              name: "Book flight",
              importance: 0.3,
              stress: 0.6,
              levelOfEffort: 0,
            },
            {
              name: "Book hotels",
              importance: 0.3,
              stress: 0.6,
              levelOfEffort: 0,
            },
            {
              name: "ON FRIDAY, talk to her about the plan",
              importance: 0.5,
              stress: 0.5,
              levelOfEffort: 1,
            },
          ],
        },
        {
          name: "Babies",
          importance: 0.9,
          stress: 0.3,
          levelOfEffort: 0,
          children: [
            {
              name: "AFTER the book arrives, read the book",
              importance: 0.8,
              stress: 0.3,
              levelOfEffort: 0,
            },
          ],
        },
      ],
    },
    {
      name: "USP",
      importance: 0.9,
      stress: 0.3,
      children: [
        {
          name: "Data Engineering",
          importance: 0.2,
          stress: 0.2,
          levelOfEffort: 0,
        },
        {
          name: "Leadership",
          importance: 0.9,
          stress: 0.6,
          levelOfEffort: 0,
          children: [
            {
              name: "Amanda thing",
              importance: 0.9,
              stress: 0.7,
              levelOfEffort: 0,
            },
            {
              name: "Erwina",
              importance: 1,
              stress: 0.8,
              levelOfEffort: 0,
              children: [
                {
                  name: "Wejdan",
                  importance: 0.8,
                  stress: 1,
                  levelOfEffort: 0,
                  children: [
                    {
                      name: "Shreyash",
                      importance: 0.6,
                      stress: 1,
                      levelOfEffort: 0,
                    },
                  ],
                },
              ],
            },
            {
              name: "Establish a baseline",
              importance: 1,
              stress: 0.8,
              levelOfEffort: 0,
            },
          ],
        },
        {
          name: "Shortage Model",
          importance: 0.7,
          stress: 1,
          levelOfEffort: 0,
          children: [
            {
              name: "Downstream data for feature engineering",
              importance: 1,
              stress: 0.8,
              levelOfEffort: 0,
              children: [
                {
                  name: "Logicstream",
                  importance: 0.8,
                  stress: 1,
                  levelOfEffort: 0,
                  children: [
                    {
                      name: "Send strategy memo, quid pro quo",
                      importance: 0.6,
                      stress: 1,
                      levelOfEffort: 0,
                    },
                  ],
                },
              ],
            },
            {
              name: "Establish a baseline",
              importance: 1,
              stress: 0.8,
              levelOfEffort: 0,
            },
          ],
        },
        {
          name: "Frontend workplan",
          importance: 0.5,
          stress: 1,
          levelOfEffort: 0,
          children: [
            {
              name: "UX/UI assessment",
              importance: 1,
              stress: 0.8,
              levelOfEffort: 0,
              children: [
                {
                  name: "Talk to Rich",
                  importance: 1,
                  stress: 0.8,
                  levelOfEffort: 0,
                },
              ],
            },
          ],
        },
        {
          name: "Infrastructure workplan",
          importance: 0.5,
          stress: 1,
          levelOfEffort: 0,
        },
        {
          name: "Internal value",
          importance: 0.7,
          stress: 0,
          levelOfEffort: 1,
          children: [
            {
              name: "Wejdan's project",
              importance: 0.4,
              stress: 0.6,
              levelOfEffort: 0,
            },
          ],
        },
        {
          name: "Media insights",
          importance: 0.7,
          stress: 0,
          levelOfEffort: 1,
          children: [
            {
              name: "Cancer blog refresh",
              importance: 1,
              stress: 1,
              levelOfEffort: 0,
            },
            {
              name: "Quality explainer",
              importance: 0.8,
              stress: 0.95,
              levelOfEffort: 1,
              children: [
                {
                  name: "Final read through",
                  importance: 1,
                  stress: 1,
                  levelOfEffort: 0,
                },
                {
                  name: "Inspection data addition",
                  importance: 1,
                  stress: 1,
                  levelOfEffort: 0,
                },
              ],
            },
          ],
        },
        {
          name: "Mapping",
          importance: 0.7,
          stress: 0,
          levelOfEffort: 1,
          children: [
            {
              name: "OCR",
              importance: 0.6,
              stress: 0.1,
              levelOfEffort: 1,
            },
          ],
        },
        {
          name: "Customer requests",
          importance: 0.9,
          stress: 0.7,
          levelOfEffort: 0,
          children: [
            {
              name: "ASPR",
              importance: 0.8,
              stress: 0,
              levelOfEffort: 0,
            },
            {
              name: "DoD",
              importance: 0.8,
              stress: 1,
              levelOfEffort: 0,
              children: [
                {
                  name: "Essential meds",
                  importance: 0.8,
                  stress: 1,
                  levelOfEffort: 0,
                  children: [
                    {
                      name: "Read Praew's email",
                      importance: 0.6,
                      stress: 1,
                      levelOfEffort: 0,
                    },
                  ],
                },
                {
                  name: "Mike's request",
                  importance: 0.3,
                  stress: 0.5,
                  levelOfEffort: 0,
                },
              ],
            },
          ],
        },
      ],
    },
    {
      name: "Health",
      importance: 1,
      stress: 0.3,
      levelOfEffort: 0,
      children: [
        {
          name: "Walk your steps!",
          importance: 0.5,
          stress: 0,
          levelOfEffort: 0,
        },
        {
          name: "Sleep",
          importance: 0.9,
          stress: 0.7,
          levelOfEffort: 0,
        },
        {
          name: "Weight 175 by September 15th",
          importance: 0.9,
          stress: 0.7,
          levelOfEffort: 0,
        },
        {
          name: "Blood pressure under control",
          importance: 0.5,
          stress: 1,
          levelOfEffort: 0,
        },
      ],
    },

    {
      name: "TODO App",
      importance: 1,
      stress: 0,
      levelOfEffort: 0,
      children: [
        {
          name: "Beautiful UX",
          importance: 0.9,
          stress: 0,
          children: [
            {
              name: "Use level of effort to make the balls fuzzy. Lots of tech debt",
              importance: 1,
              stress: 0.2,
              levelOfEffort: 0,
            },
          ],
        },
        {
          name: "Favicon",
          importance: 0.3,
          stress: 0.1,
          levelOfEffort: 0,
        },
      ],
    },
  ],
};

const svgContainer = d3.select("#ballPit");
const width = svgContainer.node().getBoundingClientRect().width;
const height = svgContainer.node().getBoundingClientRect().height;

const svg = svgContainer
  .attr("viewBox", [0, 0, width, height])
  .attr("preserveAspectRatio", "xMidYMid meet");

const root = d3.hierarchy(data);
const links = root.links();
const nodes = root.descendants();

const simulation = d3
  .forceSimulation(nodes)
  .force(
    "link",
    d3
      .forceLink(links)
      .id((d) => d.id)
      .distance((width+height)/20)
  )
  .force("charge", d3.forceManyBody().strength(-550000/(width+height)))
  .force("center", d3.forceCenter(width / 2, height / 2))
  .force(
    "collision",
    d3.forceCollide().radius(function (d) {
      return d.radius + 2;
    })
  )
  .on("tick", ticked);

const drag = d3
  .drag()
  .on("start", dragstarted)
  .on("drag", dragged)
  .on("end", dragended);

const link = svg
  .selectAll(".link")
  .data(links)
  .enter()
  .append("line")
  .attr("class", "link")
  .attr("stroke", linkStrokeColor)
  .attr("stroke-dasharray", linkStrokeStyle)
  .attr("stroke-width", 1);

const stressColor = d3.scaleSequential(d3.interpolateRdYlGn).domain([1, 0]); // 100% is high stress (red), 0% is low stress (green)

const node = svg
  .append("g")
  .selectAll("circle")
  .data(nodes)
  .enter()
  .append("circle")
  .attr("r", (d) => d.data.importance*(width+height)/100)
  .attr("fill", (d) => stressColor(d.data.stress))
  .on("mouseover", function () {
    d3.select(this).attr("fill", "black");
  })
  .on("mouseout", function () {
    d3.select(this).attr("fill", (d) => stressColor(d.data.stress));
  })
  .call(drag);

// label.call(wrap, 80); // You can adjust '80' for desired wrapping width
const labelGroups = svg
  .append("g")
  .selectAll(".labelGroup")
  .data(nodes)
  .enter()
  .append("g")
  .call(drag);

// Inside these groups, append rectangles for background
const labelBackground = labelGroups
  .append("rect")
  .attr("fill", "white") // White background
  .attr("opacity", 0.7)
  .attr("rx", 5) // Rounded corners
  .attr("ry", 5);

// Inside these groups, also append texts for labels
const labelText = labelGroups
  .append("text")
  .attr("dy", ".35em")
  .attr("text-anchor", "middle")
  .attr("opacity", (d) => d.data.importance)
  .on("mouseover", function () {
    d3.select(this).attr("opacity", 1);
  })
  .on("mouseout", function () {
    d3.select(this).attr("opacity", (d) => d.data.importance);
  })
  .text((d) => d.data.name)
  .call(wrap, 150)
  .each(function (d) {
    const bbox = this.getBBox();
    d.bbox = bbox;
    d3.select(this.previousSibling) // selects the rectangle (it's before the text in the DOM)
      .attr("x", bbox.x - 2)
      .attr("y", bbox.y - 2)
      .attr("width", bbox.width + 4)
      .attr("height", bbox.height + 4);
  });

function linkStrokeColor(d) {
  return d.source.levelOfEffort > 0.8 || d.target.levelOfEffort > 0.8
    ? "grey"
    : "#000000";
}

function linkStrokeStyle(d) {
  return d.source.levelOfEffort > 0.8 || d.target.levelOfEffort > 0.8
    ? "2,2"
    : ""; // 2,2 creates a dashed pattern
}

function ticked() {
  link
    .attr("x1", (d) => d.source.x)
    .attr("y1", (d) => d.source.y)
    .attr("x2", (d) => d.target.x)
    .attr("y2", (d) => d.target.y);

  node
    .attr("cx", (d) => d.x = Math.max(1, Math.min(d.x, width*0.95)))
    .attr("cy", (d) => d.y = Math.max(1, Math.min(d.y, height*0.95)));

  labelGroups.attr("transform", (d) => `translate(${d.x}, ${d.y})`);
}

function dragstarted(d) {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(d) {
  d.fx = d3.event.x;
  d.fy = d3.event.y;
}

function dragended(d) {
  if (!d3.event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

function wrap(text, width) {
  text.each(function () {
    const text = d3.select(this),
      words = text.text().split(/\s+/).reverse(),
      lineHeight = 1.1,
      y = text.attr("y");
    dy = parseFloat(text.attr("dy"));

    let word,
      line = [],
      lineNumber = 0,
      tspan = text
        .text(null)
        .append("tspan")
        .attr("x", 0)
        .attr("y", y)
        .attr("dy", `${dy}em`);

    while ((word = words.pop())) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        tspan = text
          .append("tspan")
          .attr("x", 0)
          .attr("y", y)
          .attr("dy", `${++lineNumber * lineHeight + dy}em`)
          .text(word);
        lineNumber -= 1;
      }
    }
  });

  window.addEventListener("resize", function () {
    const newWidth = window.innerWidth;
    const newHeight = window.innerHeight;

    svg.attr("width", newWidth).attr("height", newHeight);
  });
}
